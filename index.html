<script>
function t(s){ return String(s||'').trim(); }

// Replace unicode ops and add implicit "*"
function sanitize(expr){
  let e = String(expr)
    .replace(/×|x(?=\s*\d|\()/gi,'*')   // × or x as multiply
    .replace(/÷/g,'/')                  // ÷ to /
    .replace(/–/g,'-');                 // en-dash to minus
  // insert * for 2y, 3(x+1), )(
  e = e.replace(/(\d)\s*([a-zA-Z])/g, '$1*$2')
       .replace(/([a-zA-Z])\s*(\d)/g, '$1*$2')
       .replace(/(\d)\s*\(/g, '$1*(')
       .replace(/\)\s*\(/g, ')*(');
  return e;
}

function classify(expr, forced){
  if (forced && forced!=='auto') return forced;
  if (/^diff\(|d\/dx/i.test(expr)) return 'derivative';
  if (/^int\(|∫/i.test(expr)) return 'integral';
  if (/limit\(/i.test(expr)) return 'limit';
  if (/\[.*\]/.test(expr) || /matrix|det|inverse/i.test(expr)) return 'matrix';
  if (/=/.test(expr)) return 'equation';
  // no letters & no "=" → arithmetic
  if (!/[a-zA-Z]/.test(expr)) return 'arithmetic';
  return 'algebra';
}

function show(steps=[], ans=''){
  const box = document.getElementById('steps');
  box.innerHTML = (steps && steps.length)
    ? steps.map(s=>`<div class="step">${s}</div>`).join('')
    : '<div class="muted">No steps.</div>';
  document.getElementById('answer').textContent = ans;
}

/********** SOLVERS **********/

function arithmeticEval(expr){
  try{
    const val = math.evaluate(expr);
    return {steps:[`Compute ${expr}`], answer: String(val)};
  }catch(e){ return null; }
}

function algebraSteps(expr){
  try{
    const out = mathsteps.simplifyExpression(expr);
    if (out.length){
      const steps = out.map(s => `${s.changeType.replace(/_/g,' ')} → ${s.newExpression}`);
      return {steps, answer: out.at(-1).newExpression.toString()};
    }
  }catch(e){}
  try{
    const ans = nerdamer(expr).toString();
    return {steps:['Symbolic simplification (nerdamer)'], answer: ans};
  }catch(e){ return null; }
}

function solveEquation(expr){
  try{
    const [L,R] = expr.split('=').map(t);
    // detect main variable (first letter in expression); default x
    const varMatch = (L+R).match(/[a-zA-Z]/);
    const v = varMatch ? varMatch[0] : 'x';

    // Nerdamer wants explicit "*"
    const sol = nerdamer.solve(`${L}-(${R})`, v); // solve L-R = 0 for v
    const steps = [
      'Move all terms to one side: ' + `${L} - (${R}) = 0`,
      `Solve for ${v}`
    ];
    return {steps, answer: sol.toString()};
  }catch(e){ 
    return {steps:['Tried equation solve (nerdamer)'], answer:'Unable to solve here'};
  }
}

function derivative(expr){
  try{
    const xexpr = expr.replace(/^diff\(/i,'').replace(/\)$/, '').replace(/^d\/dx\s*/i,'');
    const ans = nerdamer.diff(xexpr,'x').toString();
    return {steps:['Apply derivative rules','Simplify'], answer: ans};
  }catch(e){ return null; }
}

function integral(expr){
  try{
    const inside = expr.replace(/^int\(/i,'').replace(/\)$/, '').replace(/^∫/,'');
    const ans = nerdamer.integrate(inside,'x').toString();
    return {steps:['Integrate term-by-term','Add C'], answer: ans + ' + C'};
  }catch(e){
    return {steps:['Needs special function or backend'], answer:'(Cannot integrate here)'}; 
  }
}

function limitEval(expr){
  const m = expr.match(/limit\((.*),\s*([a-zA-Z]),\s*([^,)]+)\)/i);
  if(!m) return null;
  try{
    const ans = nerdamer(`limit(${m[1]}, ${m[2]}, ${m[3]})`).toString();
    return {steps:['Apply limit rules / substitution'], answer: ans};
  }catch(e){ return null; }
}

function matrixOps(expr){
  try{
    if (/^det/i.test(expr)){
      const M = JSON.parse(expr.replace(/^det/i,''));
      const det = math.det(M);
      return {steps:['Compute determinant'], answer: String(det)};
    }
    if (/^inverse/i.test(expr)){
      const M = JSON.parse(expr.replace(/^inverse/i,''));
      const inv = math.inv(M);
      return {steps:['Compute inverse (Gauss/adjoint)'], answer: JSON.stringify(inv)};
    }
  }catch(e){}
  return {steps:['Matrix requested'], answer:'Try: det[[1,2],[3,4]]'};
}

/********** ROUTER **********/
async function solve(){
  const forced = document.getElementById('topic').value;
  let expr = t(document.getElementById('question').value);
  if(!expr) return show([], 'Enter a math expression');

  expr = sanitize(expr);
  const type = classify(expr, forced);

  let res = null;
  if (type==='arithmetic') res = arithmeticEval(expr);
  else if (type==='algebra') res = algebraSteps(expr);
  else if (type==='equation') res = solveEquation(expr);
  else if (type==='derivative') res = derivative(expr);
  else if (type==='integral') res = integral(expr);
  else if (type==='limit') res = limitEval(expr);
  else if (type==='matrix') res = matrixOps(expr);

  if (!res || !res.answer) res = {steps:['Could not solve on device'], answer:'Try a different form or we add backend next.'};
  show(res.steps, res.answer);
}
</script>
